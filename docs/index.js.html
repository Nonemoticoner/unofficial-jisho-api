<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>index.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="API.html">API</a><ul class='methods'><li data-type='method'><a href="API.html#searchForExamples">searchForExamples</a></li><li data-type='method'><a href="API.html#searchForKanji">searchForKanji</a></li><li data-type='method'><a href="API.html#searchForPhrase">searchForPhrase</a></li></ul></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 * This module encapsulates the official Jisho.org API
 * and also provides kanji and example search features that scrape Jisho.org.
 * Permission to scrape granted by Jisho's admin Kimtaro:
 *     http://jisho.org/forum/54fefc1f6e73340b1f160000-is-there-any-kind-of-search-api
 */

const request = require('request-promise');
const cheerio = require('cheerio');
const escapeStringRegexp = require('escape-string-regexp');
const { XmlEntities } = require('html-entities');

const JISHO_API = 'http://jisho.org/api/v1/search/words';
const SCRAPE_BASE_URI = 'http://jisho.org/search/';
const STROKE_ORDER_DIAGRAM_BASE_URI = 'http://classic.jisho.org/static/images/stroke_diagrams/';

const htmlEntities = new XmlEntities();

/* KANJI SEARCH FUNCTIONS START */

const ONYOMI_LOCATOR_SYMBOL = 'On';
const KUNYOMI_LOCATOR_SYMBOL = 'Kun';

function removeNewlines(str) {
  return str.replace(/(?:\r|\n)/g, '').trim();
}

function uriForKanjiSearch(kanji) {
  return `${SCRAPE_BASE_URI}${encodeURIComponent(kanji)}%23kanji`;
}

function getUriForStrokeOrderDiagram(kanji) {
  return `${STROKE_ORDER_DIAGRAM_BASE_URI}${kanji.charCodeAt(0).toString()}_frames.png`;
}

function uriForPhraseSearch(phrase) {
  return `${JISHO_API}?keyword=${phrase}`;
}

function containsKanjiGlyph(pageHtml, kanji) {
  const kanjiGlyphToken = `&lt;h1 class="character" data-area-name="print" lang="ja">${kanji}&lt;/h1>`;
  return pageHtml.indexOf(kanjiGlyphToken) !== -1;
}

function getStringBetweenIndicies(data, startIndex, endIndex) {
  const result = data.substring(startIndex, endIndex);
  return removeNewlines(result).trim();
}

function getStringBetweenStrings(data, startString, endString) {
  const regex = new RegExp(`${escapeStringRegexp(startString)}(.*?)${escapeStringRegexp(endString)}`, 's');
  const match = data.match(regex);

  return match ? match[1] : undefined;
}

function getIntBetweenStrings(pageHtml, startString, endString) {
  const stringBetweenStrings = getStringBetweenStrings(pageHtml, startString, endString);
  if (stringBetweenStrings) {
    return parseInt(stringBetweenStrings, 10);
  }

  return undefined;
}

function getAllGlobalGroupMatches(str, regex) {
  let regexResult = regex.exec(str);
  const results = [];
  while (regexResult) {
    results.push(regexResult[1]);
    regexResult = regex.exec(str);
  }

  return results;
}

function parseAnchorsToArray(str) {
  const regex = /&lt;a href=".*?">(.*?)&lt;\/a>/g;
  return getAllGlobalGroupMatches(str, regex);
}

function getYomi(pageHtml, yomiLocatorSymbol) {
  const yomiSection = getStringBetweenStrings(pageHtml, `&lt;dt>${yomiLocatorSymbol}:&lt;/dt>`, '&lt;/dl>');
  return parseAnchorsToArray(yomiSection || '');
}

function getKunyomi(pageHtml) {
  return getYomi(pageHtml, KUNYOMI_LOCATOR_SYMBOL);
}

function getOnyomi(pageHtml) {
  return getYomi(pageHtml, ONYOMI_LOCATOR_SYMBOL);
}

function getYomiExamples(pageHtml, yomiLocatorSymbol) {
  const locatorString = `&lt;h2>${yomiLocatorSymbol} reading compounds&lt;/h2>`;
  const exampleSection = getStringBetweenStrings(pageHtml, locatorString, '&lt;/ul>');
  if (!exampleSection) {
    return [];
  }

  const regex = /&lt;li>(.*?)&lt;\/li>/gs;
  const regexResults = getAllGlobalGroupMatches(exampleSection, regex).map(s => s.trim());

  const examples = regexResults.map((regexResult) => {
    const examplesLines = regexResult.split('\n').map(s => s.trim());
    return {
      examples: examplesLines[0],
      reading: examplesLines[1].replace('【', '').replace('】', ''),
      meaning: htmlEntities.decode(examplesLines[2]),
    };
  });

  return examples;
}

function getOnyomiExamples(pageHtml) {
  return getYomiExamples(pageHtml, ONYOMI_LOCATOR_SYMBOL);
}

function getKunyomiExamples(pageHtml) {
  return getYomiExamples(pageHtml, KUNYOMI_LOCATOR_SYMBOL);
}

function getRadical(pageHtml) {
  const radicalMeaningStartString = '&lt;span class="radical_meaning">';
  const radicalMeaningEndString = '&lt;/span>';

  const radicalMeaning = getStringBetweenStrings(
    pageHtml,
    radicalMeaningStartString,
    radicalMeaningEndString,
  ).trim();

  if (radicalMeaning) {
    const radicalMeaningStartIndex = pageHtml.indexOf(radicalMeaningStartString);

    const radicalMeaningEndIndex = pageHtml.indexOf(
      radicalMeaningEndString,
      radicalMeaningStartIndex,
    );

    const radicalSymbolStartIndex = radicalMeaningEndIndex + radicalMeaningEndString.length;
    const radicalSymbolEndString = '&lt;/span>';
    const radicalSymbolEndIndex = pageHtml.indexOf(radicalSymbolEndString, radicalSymbolStartIndex);

    const radicalSymbolsString = getStringBetweenIndicies(
      pageHtml,
      radicalSymbolStartIndex,
      radicalSymbolEndIndex,
    );

    if (radicalSymbolsString.length > 1) {
      const radicalForms = radicalSymbolsString
        .substring(1)
        .replace('(', '')
        .replace(')', '')
        .trim()
        .split(', ');

      return { symbol: radicalSymbolsString[0], forms: radicalForms, meaning: radicalMeaning };
    }

    return { symbol: radicalSymbolsString, meaning: radicalMeaning };
  }

  return undefined;
}

function getParts(pageHtml) {
  const partsSectionStartString = '&lt;dt>Parts:&lt;/dt>';
  const partsSectionEndString = '&lt;/dl>';

  const partsSection = getStringBetweenStrings(
    pageHtml,
    partsSectionStartString,
    partsSectionEndString,
  );

  return parseAnchorsToArray(partsSection);
}

function getSvgUri(pageHtml) {
  const svgRegex = /\/\/.*?.cloudfront.net\/.*?.svg/;
  const regexResult = svgRegex.exec(pageHtml);
  return regexResult ? `http:${regexResult[0]}` : undefined;
}

function getGifUri(kanji) {
  const fileCodeStringLength = 5;
  const unicodeString = kanji.codePointAt(0).toString(16);
  const fillZeroes = fileCodeStringLength - unicodeString.length;
  const fileCode = new Array(fillZeroes + 1).join('0') + unicodeString;
  const fileName = `${fileCode}_anim.gif`;
  const animationUri = `https://raw.githubusercontent.com/mistval/kotoba/master/resources/images/kanjianimations/${fileName}`;

  return animationUri;
}

function getNewspaperFrequencyRank(pageHtml) {
  const frequencySection = getStringBetweenStrings(pageHtml, '&lt;div class="frequency">', '&lt;/div>');
  return frequencySection ? getStringBetweenStrings(frequencySection, '&lt;strong>', '&lt;/strong>') : undefined;
}

function parseKanjiPageData(pageHtml, kanji) {
  const result = {};
  result.query = kanji;
  result.found = containsKanjiGlyph(pageHtml, kanji);
  if (!result.found) {
    return result;
  }

  result.taughtIn = getStringBetweenStrings(pageHtml, 'taught in &lt;strong>', '&lt;/strong>');
  result.jlptLevel = getStringBetweenStrings(pageHtml, 'JLPT level &lt;strong>', '&lt;/strong>');
  result.newspaperFrequencyRank = getNewspaperFrequencyRank(pageHtml);
  result.strokeCount = getIntBetweenStrings(pageHtml, '&lt;strong>', '&lt;/strong> strokes');
  result.meaning = htmlEntities.decode(removeNewlines(getStringBetweenStrings(pageHtml, '&lt;div class="kanji-details__main-meanings">', '&lt;/div>')).trim());
  result.kunyomi = getKunyomi(pageHtml);
  result.onyomi = getOnyomi(pageHtml);
  result.onyomiExamples = getOnyomiExamples(pageHtml);
  result.kunyomiExamples = getKunyomiExamples(pageHtml);
  result.radical = getRadical(pageHtml);
  result.parts = getParts(pageHtml);
  result.strokeOrderDiagramUri = getUriForStrokeOrderDiagram(kanji);
  result.strokeOrderSvgUri = getSvgUri(pageHtml);
  result.strokeOrderGifUri = getGifUri(kanji);
  result.uri = uriForKanjiSearch(kanji);
  return result;
}

/* KANJI SEARCH FUNCTIONS END */

/* EXAMPLE SEARCH FUNCTIONS START */

const kanjiRegex = /[\u4e00-\u9faf\u3400-\u4dbf]/g;

function uriForExampleSearch(phrase) {
  return `${SCRAPE_BASE_URI}${encodeURIComponent(phrase)}%23sentences`;
}

function getKanjiAndKana(div) {
  const ul = div.find('ul').eq(0);
  const contents = ul.contents();

  let kanji = '';
  let kana = '';
  for (let i = 0; i &lt; contents.length; i += 1) {
    const content = contents.eq(i);
    if (content[0].name === 'li') {
      const li = content;
      const furigana = li.find('.furigana').text();
      const unlifted = li.find('.unlinked').text();

      if (furigana) {
        kanji += unlifted;
        kana += furigana;

        for (let j = 0; j &lt; unlifted.length; j += 1) {
          if (!unlifted[j].match(kanjiRegex)) {
            kana += unlifted[j];
          }
        }
      } else {
        kanji += unlifted;
        kana += unlifted;
      }
    } else {
      const text = content.text().trim();
      if (text) {
        kanji += text;
        kana += text;
      }
    }
  }

  return { kanji, kana };
}

function parseExampleDiv(div) {
  const english = div.find('.english').text();
  const { kanji, kana } = getKanjiAndKana(div);

  return {
    english,
    kanji,
    kana,
  };
}

function parseExamplePageData(pageHtml, phrase) {
  const $ = cheerio.load(pageHtml);
  const divs = $('.sentence_content');

  const results = [];
  for (let i = 0; i &lt; divs.length; i += 1) {
    const div = divs.eq(i);
    results.push(parseExampleDiv(div));
  }

  return {
    query: phrase,
    found: results.length > 0,
    results,
    uri: uriForExampleSearch(phrase),
    phrase,
  };
}

/* EXAMPLE SEARCH FUNCTIONS END */

/**
 * @typedef {Object} YomiExample
 * @property {string} example The original text of the example.
 * @property {string} reading The reading of the example.
 * @property {string} meaning The meaning of the example.
 */

/**
 * @typedef {Object} KanjiResult
 * @property {boolean} found True if results were found.
 * @property {string} query The term that you searched for.
 * @property {string} [taughtIn] The school level that the kanji is taught in, if applicable.
 * @property {string} [jlptLevel] The lowest JLPT exam that this kanji is likely to
 *   appear in, if applicable. 'N5' or 'N4' or 'N3' or 'N2' or 'N1'.
 * @property {number} [newspaperFrequencyRank] A number representing this kanji's frequency rank
 *   in newspapers, if applicable.
 * @property {number} [strokeCount] How many strokes this kanji is typically drawn in,
 *   if applicable.
 * @property {string} [meaning] The meaning of the kanji, if applicable.
 * @property {Array.&lt;string>} [kunyomi] This character's kunyomi, if applicable.
 * @property {Array.&lt;YomiExample>} [kunyomiExamples] Examples of this character's kunyomi
 *   being used, if applicable.
 * @property {string} [onyomi] This character's onyomi, if applicable.
 * @property {Array.&lt;YomiExample>} [onyomiExamples] Examples of this character's onyomi
 *   being used, if applicable.
 * @property {Object} [radical] Information about this character's radical, if applicable.
 * @property {string} [radical.symbol] The radical symbol, if applicable.
 * @property {Array.&lt;string>} [radical.forms] The radical forms used in this kanji, if applicable.
 * @property {string} [radical.meaning] The meaning of the radical, if applicable.
 * @property {Array.&lt;string>} [parts] The parts used in this kanji, if applicable.
 * @property {string} [strokeOrderDiagramUri] The URL to a diagram showing how to draw this kanji
 *   step by step, if applicable.
 * @property {string} [strokeOrderSvgUri] The URL to an SVG describing how to draw this kanji,
 *   if applicable.
 * @property {string} [strokeOrderGifUri] The URL to a gif showing the kanji being draw and its
 *   stroke order, if applicable.
 * @property {string} [uri] The URI that these results were scraped from, if applicable.
 */

/**
 * @typedef {Object} ExampleResultData
 * @property {string} kanji The example sentence including kanji.
 * @property {string} kana The example sentence without kanji (only kana). Sometimes this may
 *   include some Kanji, as furigana is not always available from Jisho.org.
 * @property {string} english An English translation of the example.
 */

 /**
  * @typedef {Object} ExampleResults
  * @property {string} query The term that you searched for.
  * @property {boolean} found True if results were found.
  * @property {string} uri The URI that these results were scraped from.
  * @property {Array.&lt;ExampleResultData>} results The examples that were found, if any.
  */

class API {
  /**
   * A wrapper around the Jisho.org API and this library's scraping functionality.
   * @param {Object} requestOptions Options to pass to
   *   [request]{@link https://www.npmjs.com/package/request} to customize request behavior.
   *   See [request]{@link https://www.npmjs.com/package/request} for available options.
   *   requestOptions passed into this constructor can be overriden by passing requestOptions
   *   to the search methods.
   */
  constructor(requestOptions) {
    this.requestOptions = requestOptions;
  }

  /**
   * Query the official Jisho API for a word or phrase. See
   * [here]{@link https://jisho.org/forum/54fefc1f6e73340b1f160000-is-there-any-kind-of-search-api}
   * for discussion about the official API.
   * @param {string} phrase The search term to search for.
   * @param {Object} requestOptions Options to pass to
   *   [request]{@link https://www.npmjs.com/package/request} to customize request behavior.
   *   See [request]{@link https://www.npmjs.com/package/request} for available options.
   * @returns {Object} The response data from the official Jisho.org API. Its format is somewhat
   *   complex and is not documented, so put on your trial-and-error hat.
   * @async
   */
  searchForPhrase(phrase, requestOptions) {
    return request({
      uri: JISHO_API,
      qs: {
        keyword: phrase,
      },
      json: true,
      ...this.requestOptions,
      ...requestOptions,
    });
  }

  /**
   * Scrape Jisho.org for information about a kanji character.
   * @param {string} kanji The kanji to search for.
   * @param {Object} requestOptions Options to pass to
   *   [request]{@link https://www.npmjs.com/package/request} to customize request behavior.
   *   See [request]{@link https://www.npmjs.com/package/request} for available options.
   * @returns {KanjiResult} Information about the searched kanji.
   * @async
   */
  searchForKanji(kanji, requestOptions) {
    const uri = uriForKanjiSearch(kanji);
    return request({
      uri,
      json: false,
      ...this.requestOptions,
      ...requestOptions,
    }).then(pageHtml => parseKanjiPageData(pageHtml, kanji)).catch((err) => {
      // Seems to be a bug in Jisho that if you enter a URI encoded URI into the search,
      // it gives you a 404 instead of a regular search page with empty results.
      // So handle 404 the same way as empty results.
      if (err.message.indexOf('The page you were looking for doesn\'t exist') !== -1) {
        return parseKanjiPageData(err.message, kanji);
      }
      throw err;
    });
  }

  /**
   * 
   * @param {string} phrase The word or phrase to search for.
   * @param {Object} requestOptions Options to pass to
   *   [request]{@link https://www.npmjs.com/package/request} to customize request behavior.
   *   See [request]{@link https://www.npmjs.com/package/request} for available options.
   * @returns {ExampleResults} 
   * @async
   */
  searchForExamples(phrase, requestOptions) {
    const uri = uriForExampleSearch(phrase);
    return request({
      uri,
      json: false,
      ...this.requestOptions,
      ...requestOptions,
    }).then(pageHtml => parseExamplePageData(pageHtml, phrase));
  }
}

API.prototype.getUriForKanjiSearch = uriForKanjiSearch;
API.prototype.getUriForExampleSearch = uriForExampleSearch;
API.prototype.getUriForPhraseSearch = uriForPhraseSearch;
API.prototype.parseExamplePageHtml = parseExamplePageData;
API.prototype.parseKanjiPageHtml = parseKanjiPageData;

module.exports = API;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Feb 08 2019 15:02:41 GMT+0700 (GMT+07:00) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>


</body>
</html>
